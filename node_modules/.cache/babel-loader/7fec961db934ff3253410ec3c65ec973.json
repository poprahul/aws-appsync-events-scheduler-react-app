{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nimport { isEqual, tryFunctionOrLogError, cloneDeep } from 'apollo-utilities';\nimport { NetworkStatus, isNetworkRequestInFlight } from './networkStatus';\nimport { Observable } from '../util/Observable';\nimport { ApolloError } from '../errors/ApolloError';\nimport { FetchType } from './types';\nexport var hasError = function (storeValue, policy) {\n  if (policy === void 0) {\n    policy = 'none';\n  }\n\n  return storeValue && (storeValue.graphQLErrors && storeValue.graphQLErrors.length > 0 && policy === 'none' || storeValue.networkError);\n};\n\nvar ObservableQuery = function (_super) {\n  __extends(ObservableQuery, _super);\n\n  function ObservableQuery(_a) {\n    var scheduler = _a.scheduler,\n        options = _a.options,\n        _b = _a.shouldSubscribe,\n        shouldSubscribe = _b === void 0 ? true : _b;\n\n    var _this = _super.call(this, function (observer) {\n      return _this.onSubscribe(observer);\n    }) || this;\n\n    _this.isCurrentlyPolling = false;\n    _this.isTornDown = false;\n    _this.options = options;\n    _this.variables = options.variables || {};\n    _this.queryId = scheduler.queryManager.generateQueryId();\n    _this.shouldSubscribe = shouldSubscribe;\n    _this.scheduler = scheduler;\n    _this.queryManager = scheduler.queryManager;\n    _this.observers = [];\n    _this.subscriptionHandles = [];\n    return _this;\n  }\n\n  ObservableQuery.prototype.result = function () {\n    var that = this;\n    return new Promise(function (resolve, reject) {\n      var subscription;\n      var observer = {\n        next: function (result) {\n          resolve(result);\n\n          if (!that.observers.some(function (obs) {\n            return obs !== observer;\n          })) {\n            that.queryManager.removeQuery(that.queryId);\n          }\n\n          setTimeout(function () {\n            subscription.unsubscribe();\n          }, 0);\n        },\n        error: function (error) {\n          reject(error);\n        }\n      };\n      subscription = that.subscribe(observer);\n    });\n  };\n\n  ObservableQuery.prototype.currentResult = function () {\n    if (this.isTornDown) {\n      return {\n        data: this.lastError ? {} : this.lastResult ? this.lastResult.data : {},\n        error: this.lastError,\n        loading: false,\n        networkStatus: NetworkStatus.error\n      };\n    }\n\n    var queryStoreValue = this.queryManager.queryStore.get(this.queryId);\n\n    if (hasError(queryStoreValue, this.options.errorPolicy)) {\n      return {\n        data: {},\n        loading: false,\n        networkStatus: queryStoreValue.networkStatus,\n        error: new ApolloError({\n          graphQLErrors: queryStoreValue.graphQLErrors,\n          networkError: queryStoreValue.networkError\n        })\n      };\n    }\n\n    var _a = this.queryManager.getCurrentQueryResult(this),\n        data = _a.data,\n        partial = _a.partial;\n\n    var queryLoading = !queryStoreValue || queryStoreValue.networkStatus === NetworkStatus.loading;\n    var loading = this.options.fetchPolicy === 'network-only' && queryLoading || partial && this.options.fetchPolicy !== 'cache-only';\n    var networkStatus;\n\n    if (queryStoreValue) {\n      networkStatus = queryStoreValue.networkStatus;\n    } else {\n      networkStatus = loading ? NetworkStatus.loading : NetworkStatus.ready;\n    }\n\n    var result = {\n      data: data,\n      loading: isNetworkRequestInFlight(networkStatus),\n      networkStatus: networkStatus\n    };\n\n    if (queryStoreValue && queryStoreValue.graphQLErrors && this.options.errorPolicy === 'all') {\n      result.errors = queryStoreValue.graphQLErrors;\n    }\n\n    if (!partial) {\n      this.lastResult = __assign({}, result, {\n        stale: false\n      });\n      this.lastResultSnapshot = cloneDeep(this.lastResult);\n    }\n\n    return __assign({}, result, {\n      partial: partial\n    });\n  };\n\n  ObservableQuery.prototype.isDifferentFromLastResult = function (newResult) {\n    var snapshot = this.lastResultSnapshot;\n    return !(snapshot && newResult && snapshot.networkStatus === newResult.networkStatus && snapshot.stale === newResult.stale && isEqual(snapshot.data, newResult.data));\n  };\n\n  ObservableQuery.prototype.getLastResult = function () {\n    return this.lastResult;\n  };\n\n  ObservableQuery.prototype.getLastError = function () {\n    return this.lastError;\n  };\n\n  ObservableQuery.prototype.resetLastResults = function () {\n    delete this.lastResult;\n    delete this.lastResultSnapshot;\n    delete this.lastError;\n    this.isTornDown = false;\n  };\n\n  ObservableQuery.prototype.refetch = function (variables) {\n    var fetchPolicy = this.options.fetchPolicy;\n\n    if (fetchPolicy === 'cache-only') {\n      return Promise.reject(new Error('cache-only fetchPolicy option should not be used together with query refetch.'));\n    }\n\n    if (!isEqual(this.variables, variables)) {\n      this.variables = Object.assign({}, this.variables, variables);\n    }\n\n    if (!isEqual(this.options.variables, this.variables)) {\n      this.options.variables = Object.assign({}, this.options.variables, this.variables);\n    }\n\n    var isNetworkFetchPolicy = fetchPolicy === 'network-only' || fetchPolicy === 'no-cache';\n\n    var combinedOptions = __assign({}, this.options, {\n      fetchPolicy: isNetworkFetchPolicy ? fetchPolicy : 'network-only'\n    });\n\n    return this.queryManager.fetchQuery(this.queryId, combinedOptions, FetchType.refetch).then(function (result) {\n      return result;\n    });\n  };\n\n  ObservableQuery.prototype.fetchMore = function (fetchMoreOptions) {\n    var _this = this;\n\n    if (!fetchMoreOptions.updateQuery) {\n      throw new Error('updateQuery option is required. This function defines how to update the query data with the new results.');\n    }\n\n    var combinedOptions;\n    return Promise.resolve().then(function () {\n      var qid = _this.queryManager.generateQueryId();\n\n      if (fetchMoreOptions.query) {\n        combinedOptions = fetchMoreOptions;\n      } else {\n        combinedOptions = __assign({}, _this.options, fetchMoreOptions, {\n          variables: Object.assign({}, _this.variables, fetchMoreOptions.variables)\n        });\n      }\n\n      combinedOptions.fetchPolicy = 'network-only';\n      return _this.queryManager.fetchQuery(qid, combinedOptions, FetchType.normal, _this.queryId);\n    }).then(function (fetchMoreResult) {\n      _this.updateQuery(function (previousResult) {\n        return fetchMoreOptions.updateQuery(previousResult, {\n          fetchMoreResult: fetchMoreResult.data,\n          variables: combinedOptions.variables\n        });\n      });\n\n      return fetchMoreResult;\n    });\n  };\n\n  ObservableQuery.prototype.subscribeToMore = function (options) {\n    var _this = this;\n\n    var subscription = this.queryManager.startGraphQLSubscription({\n      query: options.document,\n      variables: options.variables\n    }).subscribe({\n      next: function (subscriptionData) {\n        if (options.updateQuery) {\n          _this.updateQuery(function (previous, _a) {\n            var variables = _a.variables;\n            return options.updateQuery(previous, {\n              subscriptionData: subscriptionData,\n              variables: variables\n            });\n          });\n        }\n      },\n      error: function (err) {\n        if (options.onError) {\n          options.onError(err);\n          return;\n        }\n\n        console.error('Unhandled GraphQL subscription error', err);\n      }\n    });\n    this.subscriptionHandles.push(subscription);\n    return function () {\n      var i = _this.subscriptionHandles.indexOf(subscription);\n\n      if (i >= 0) {\n        _this.subscriptionHandles.splice(i, 1);\n\n        subscription.unsubscribe();\n      }\n    };\n  };\n\n  ObservableQuery.prototype.setOptions = function (opts) {\n    var oldOptions = this.options;\n    this.options = Object.assign({}, this.options, opts);\n\n    if (opts.pollInterval) {\n      this.startPolling(opts.pollInterval);\n    } else if (opts.pollInterval === 0) {\n      this.stopPolling();\n    }\n\n    var tryFetch = oldOptions.fetchPolicy !== 'network-only' && opts.fetchPolicy === 'network-only' || oldOptions.fetchPolicy === 'cache-only' && opts.fetchPolicy !== 'cache-only' || oldOptions.fetchPolicy === 'standby' && opts.fetchPolicy !== 'standby' || false;\n    return this.setVariables(this.options.variables, tryFetch, opts.fetchResults);\n  };\n\n  ObservableQuery.prototype.setVariables = function (variables, tryFetch, fetchResults) {\n    if (tryFetch === void 0) {\n      tryFetch = false;\n    }\n\n    if (fetchResults === void 0) {\n      fetchResults = true;\n    }\n\n    this.isTornDown = false;\n    var newVariables = variables ? variables : this.variables;\n\n    if (isEqual(newVariables, this.variables) && !tryFetch) {\n      if (this.observers.length === 0 || !fetchResults) {\n        return new Promise(function (resolve) {\n          return resolve();\n        });\n      }\n\n      return this.result();\n    } else {\n      this.variables = newVariables;\n      this.options.variables = newVariables;\n\n      if (this.observers.length === 0) {\n        return new Promise(function (resolve) {\n          return resolve();\n        });\n      }\n\n      return this.queryManager.fetchQuery(this.queryId, __assign({}, this.options, {\n        variables: this.variables\n      })).then(function (result) {\n        return result;\n      });\n    }\n  };\n\n  ObservableQuery.prototype.updateQuery = function (mapFn) {\n    var _a = this.queryManager.getQueryWithPreviousResult(this.queryId),\n        previousResult = _a.previousResult,\n        variables = _a.variables,\n        document = _a.document;\n\n    var newResult = tryFunctionOrLogError(function () {\n      return mapFn(previousResult, {\n        variables: variables\n      });\n    });\n\n    if (newResult) {\n      this.queryManager.dataStore.markUpdateQueryResult(document, variables, newResult);\n      this.queryManager.broadcastQueries();\n    }\n  };\n\n  ObservableQuery.prototype.stopPolling = function () {\n    if (this.isCurrentlyPolling) {\n      this.scheduler.stopPollingQuery(this.queryId);\n      this.options.pollInterval = undefined;\n      this.isCurrentlyPolling = false;\n    }\n  };\n\n  ObservableQuery.prototype.startPolling = function (pollInterval) {\n    if (this.options.fetchPolicy === 'cache-first' || this.options.fetchPolicy === 'cache-only') {\n      throw new Error('Queries that specify the cache-first and cache-only fetchPolicies cannot also be polling queries.');\n    }\n\n    if (this.isCurrentlyPolling) {\n      this.scheduler.stopPollingQuery(this.queryId);\n      this.isCurrentlyPolling = false;\n    }\n\n    this.options.pollInterval = pollInterval;\n    this.isCurrentlyPolling = true;\n    this.scheduler.startPollingQuery(this.options, this.queryId);\n  };\n\n  ObservableQuery.prototype.onSubscribe = function (observer) {\n    var _this = this;\n\n    if (observer._subscription && observer._subscription._observer && !observer._subscription._observer.error) {\n      observer._subscription._observer.error = function (error) {\n        console.error('Unhandled error', error.message, error.stack);\n      };\n    }\n\n    this.observers.push(observer);\n    if (observer.next && this.lastResult) observer.next(this.lastResult);\n    if (observer.error && this.lastError) observer.error(this.lastError);\n    if (this.observers.length === 1) this.setUpQuery();\n    return function () {\n      _this.observers = _this.observers.filter(function (obs) {\n        return obs !== observer;\n      });\n\n      if (_this.observers.length === 0) {\n        _this.tearDownQuery();\n      }\n    };\n  };\n\n  ObservableQuery.prototype.setUpQuery = function () {\n    var _this = this;\n\n    if (this.shouldSubscribe) {\n      this.queryManager.addObservableQuery(this.queryId, this);\n    }\n\n    if (!!this.options.pollInterval) {\n      if (this.options.fetchPolicy === 'cache-first' || this.options.fetchPolicy === 'cache-only') {\n        throw new Error('Queries that specify the cache-first and cache-only fetchPolicies cannot also be polling queries.');\n      }\n\n      this.isCurrentlyPolling = true;\n      this.scheduler.startPollingQuery(this.options, this.queryId);\n    }\n\n    var observer = {\n      next: function (result) {\n        _this.lastResult = result;\n        _this.lastResultSnapshot = cloneDeep(result);\n\n        _this.observers.forEach(function (obs) {\n          return obs.next && obs.next(result);\n        });\n      },\n      error: function (error) {\n        _this.lastError = error;\n\n        _this.observers.forEach(function (obs) {\n          return obs.error && obs.error(error);\n        });\n      }\n    };\n    this.queryManager.startQuery(this.queryId, this.options, this.queryManager.queryListenerForObserver(this.queryId, this.options, observer));\n  };\n\n  ObservableQuery.prototype.tearDownQuery = function () {\n    this.isTornDown = true;\n\n    if (this.isCurrentlyPolling) {\n      this.scheduler.stopPollingQuery(this.queryId);\n      this.isCurrentlyPolling = false;\n    }\n\n    this.subscriptionHandles.forEach(function (sub) {\n      return sub.unsubscribe();\n    });\n    this.subscriptionHandles = [];\n    this.queryManager.removeObservableQuery(this.queryId);\n    this.queryManager.stopQuery(this.queryId);\n    this.observers = [];\n  };\n\n  return ObservableQuery;\n}(Observable);\n\nexport { ObservableQuery };","map":{"version":3,"sources":["../../src/core/ObservableQuery.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    }\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nimport { isEqual, tryFunctionOrLogError, cloneDeep } from 'apollo-utilities';\nimport { NetworkStatus, isNetworkRequestInFlight } from './networkStatus';\nimport { Observable } from '../util/Observable';\nimport { ApolloError } from '../errors/ApolloError';\nimport { FetchType } from './types';\nexport var hasError = function (storeValue, policy) {\n    if (policy === void 0) { policy = 'none'; }\n    return storeValue &&\n        ((storeValue.graphQLErrors &&\n            storeValue.graphQLErrors.length > 0 &&\n            policy === 'none') ||\n            storeValue.networkError);\n};\nvar ObservableQuery = (function (_super) {\n    __extends(ObservableQuery, _super);\n    function ObservableQuery(_a) {\n        var scheduler = _a.scheduler, options = _a.options, _b = _a.shouldSubscribe, shouldSubscribe = _b === void 0 ? true : _b;\n        var _this = _super.call(this, function (observer) {\n            return _this.onSubscribe(observer);\n        }) || this;\n        _this.isCurrentlyPolling = false;\n        _this.isTornDown = false;\n        _this.options = options;\n        _this.variables = options.variables || {};\n        _this.queryId = scheduler.queryManager.generateQueryId();\n        _this.shouldSubscribe = shouldSubscribe;\n        _this.scheduler = scheduler;\n        _this.queryManager = scheduler.queryManager;\n        _this.observers = [];\n        _this.subscriptionHandles = [];\n        return _this;\n    }\n    ObservableQuery.prototype.result = function () {\n        var that = this;\n        return new Promise(function (resolve, reject) {\n            var subscription;\n            var observer = {\n                next: function (result) {\n                    resolve(result);\n                    if (!that.observers.some(function (obs) { return obs !== observer; })) {\n                        that.queryManager.removeQuery(that.queryId);\n                    }\n                    setTimeout(function () {\n                        subscription.unsubscribe();\n                    }, 0);\n                },\n                error: function (error) {\n                    reject(error);\n                },\n            };\n            subscription = that.subscribe(observer);\n        });\n    };\n    ObservableQuery.prototype.currentResult = function () {\n        if (this.isTornDown) {\n            return {\n                data: this.lastError ? {} : this.lastResult ? this.lastResult.data : {},\n                error: this.lastError,\n                loading: false,\n                networkStatus: NetworkStatus.error,\n            };\n        }\n        var queryStoreValue = this.queryManager.queryStore.get(this.queryId);\n        if (hasError(queryStoreValue, this.options.errorPolicy)) {\n            return {\n                data: {},\n                loading: false,\n                networkStatus: queryStoreValue.networkStatus,\n                error: new ApolloError({\n                    graphQLErrors: queryStoreValue.graphQLErrors,\n                    networkError: queryStoreValue.networkError,\n                }),\n            };\n        }\n        var _a = this.queryManager.getCurrentQueryResult(this), data = _a.data, partial = _a.partial;\n        var queryLoading = !queryStoreValue ||\n            queryStoreValue.networkStatus === NetworkStatus.loading;\n        var loading = (this.options.fetchPolicy === 'network-only' && queryLoading) ||\n            (partial && this.options.fetchPolicy !== 'cache-only');\n        var networkStatus;\n        if (queryStoreValue) {\n            networkStatus = queryStoreValue.networkStatus;\n        }\n        else {\n            networkStatus = loading ? NetworkStatus.loading : NetworkStatus.ready;\n        }\n        var result = {\n            data: data,\n            loading: isNetworkRequestInFlight(networkStatus),\n            networkStatus: networkStatus,\n        };\n        if (queryStoreValue &&\n            queryStoreValue.graphQLErrors &&\n            this.options.errorPolicy === 'all') {\n            result.errors = queryStoreValue.graphQLErrors;\n        }\n        if (!partial) {\n            this.lastResult = __assign({}, result, { stale: false });\n            this.lastResultSnapshot = cloneDeep(this.lastResult);\n        }\n        return __assign({}, result, { partial: partial });\n    };\n    ObservableQuery.prototype.isDifferentFromLastResult = function (newResult) {\n        var snapshot = this.lastResultSnapshot;\n        return !(snapshot && newResult &&\n            snapshot.networkStatus === newResult.networkStatus &&\n            snapshot.stale === newResult.stale &&\n            isEqual(snapshot.data, newResult.data));\n    };\n    ObservableQuery.prototype.getLastResult = function () {\n        return this.lastResult;\n    };\n    ObservableQuery.prototype.getLastError = function () {\n        return this.lastError;\n    };\n    ObservableQuery.prototype.resetLastResults = function () {\n        delete this.lastResult;\n        delete this.lastResultSnapshot;\n        delete this.lastError;\n        this.isTornDown = false;\n    };\n    ObservableQuery.prototype.refetch = function (variables) {\n        var fetchPolicy = this.options.fetchPolicy;\n        if (fetchPolicy === 'cache-only') {\n            return Promise.reject(new Error('cache-only fetchPolicy option should not be used together with query refetch.'));\n        }\n        if (!isEqual(this.variables, variables)) {\n            this.variables = Object.assign({}, this.variables, variables);\n        }\n        if (!isEqual(this.options.variables, this.variables)) {\n            this.options.variables = Object.assign({}, this.options.variables, this.variables);\n        }\n        var isNetworkFetchPolicy = fetchPolicy === 'network-only' || fetchPolicy === 'no-cache';\n        var combinedOptions = __assign({}, this.options, { fetchPolicy: isNetworkFetchPolicy ? fetchPolicy : 'network-only' });\n        return this.queryManager\n            .fetchQuery(this.queryId, combinedOptions, FetchType.refetch)\n            .then(function (result) { return result; });\n    };\n    ObservableQuery.prototype.fetchMore = function (fetchMoreOptions) {\n        var _this = this;\n        if (!fetchMoreOptions.updateQuery) {\n            throw new Error('updateQuery option is required. This function defines how to update the query data with the new results.');\n        }\n        var combinedOptions;\n        return Promise.resolve()\n            .then(function () {\n            var qid = _this.queryManager.generateQueryId();\n            if (fetchMoreOptions.query) {\n                combinedOptions = fetchMoreOptions;\n            }\n            else {\n                combinedOptions = __assign({}, _this.options, fetchMoreOptions, { variables: Object.assign({}, _this.variables, fetchMoreOptions.variables) });\n            }\n            combinedOptions.fetchPolicy = 'network-only';\n            return _this.queryManager.fetchQuery(qid, combinedOptions, FetchType.normal, _this.queryId);\n        })\n            .then(function (fetchMoreResult) {\n            _this.updateQuery(function (previousResult) {\n                return fetchMoreOptions.updateQuery(previousResult, {\n                    fetchMoreResult: fetchMoreResult.data,\n                    variables: combinedOptions.variables,\n                });\n            });\n            return fetchMoreResult;\n        });\n    };\n    ObservableQuery.prototype.subscribeToMore = function (options) {\n        var _this = this;\n        var subscription = this.queryManager\n            .startGraphQLSubscription({\n            query: options.document,\n            variables: options.variables,\n        })\n            .subscribe({\n            next: function (subscriptionData) {\n                if (options.updateQuery) {\n                    _this.updateQuery(function (previous, _a) {\n                        var variables = _a.variables;\n                        return options.updateQuery(previous, {\n                            subscriptionData: subscriptionData,\n                            variables: variables,\n                        });\n                    });\n                }\n            },\n            error: function (err) {\n                if (options.onError) {\n                    options.onError(err);\n                    return;\n                }\n                console.error('Unhandled GraphQL subscription error', err);\n            },\n        });\n        this.subscriptionHandles.push(subscription);\n        return function () {\n            var i = _this.subscriptionHandles.indexOf(subscription);\n            if (i >= 0) {\n                _this.subscriptionHandles.splice(i, 1);\n                subscription.unsubscribe();\n            }\n        };\n    };\n    ObservableQuery.prototype.setOptions = function (opts) {\n        var oldOptions = this.options;\n        this.options = Object.assign({}, this.options, opts);\n        if (opts.pollInterval) {\n            this.startPolling(opts.pollInterval);\n        }\n        else if (opts.pollInterval === 0) {\n            this.stopPolling();\n        }\n        var tryFetch = (oldOptions.fetchPolicy !== 'network-only' &&\n            opts.fetchPolicy === 'network-only') ||\n            (oldOptions.fetchPolicy === 'cache-only' &&\n                opts.fetchPolicy !== 'cache-only') ||\n            (oldOptions.fetchPolicy === 'standby' &&\n                opts.fetchPolicy !== 'standby') ||\n            false;\n        return this.setVariables(this.options.variables, tryFetch, opts.fetchResults);\n    };\n    ObservableQuery.prototype.setVariables = function (variables, tryFetch, fetchResults) {\n        if (tryFetch === void 0) { tryFetch = false; }\n        if (fetchResults === void 0) { fetchResults = true; }\n        this.isTornDown = false;\n        var newVariables = variables ? variables : this.variables;\n        if (isEqual(newVariables, this.variables) && !tryFetch) {\n            if (this.observers.length === 0 || !fetchResults) {\n                return new Promise(function (resolve) { return resolve(); });\n            }\n            return this.result();\n        }\n        else {\n            this.variables = newVariables;\n            this.options.variables = newVariables;\n            if (this.observers.length === 0) {\n                return new Promise(function (resolve) { return resolve(); });\n            }\n            return this.queryManager\n                .fetchQuery(this.queryId, __assign({}, this.options, { variables: this.variables }))\n                .then(function (result) { return result; });\n        }\n    };\n    ObservableQuery.prototype.updateQuery = function (mapFn) {\n        var _a = this.queryManager.getQueryWithPreviousResult(this.queryId), previousResult = _a.previousResult, variables = _a.variables, document = _a.document;\n        var newResult = tryFunctionOrLogError(function () {\n            return mapFn(previousResult, { variables: variables });\n        });\n        if (newResult) {\n            this.queryManager.dataStore.markUpdateQueryResult(document, variables, newResult);\n            this.queryManager.broadcastQueries();\n        }\n    };\n    ObservableQuery.prototype.stopPolling = function () {\n        if (this.isCurrentlyPolling) {\n            this.scheduler.stopPollingQuery(this.queryId);\n            this.options.pollInterval = undefined;\n            this.isCurrentlyPolling = false;\n        }\n    };\n    ObservableQuery.prototype.startPolling = function (pollInterval) {\n        if (this.options.fetchPolicy === 'cache-first' ||\n            this.options.fetchPolicy === 'cache-only') {\n            throw new Error('Queries that specify the cache-first and cache-only fetchPolicies cannot also be polling queries.');\n        }\n        if (this.isCurrentlyPolling) {\n            this.scheduler.stopPollingQuery(this.queryId);\n            this.isCurrentlyPolling = false;\n        }\n        this.options.pollInterval = pollInterval;\n        this.isCurrentlyPolling = true;\n        this.scheduler.startPollingQuery(this.options, this.queryId);\n    };\n    ObservableQuery.prototype.onSubscribe = function (observer) {\n        var _this = this;\n        if (observer._subscription &&\n            observer._subscription._observer &&\n            !observer._subscription._observer.error) {\n            observer._subscription._observer.error = function (error) {\n                console.error('Unhandled error', error.message, error.stack);\n            };\n        }\n        this.observers.push(observer);\n        if (observer.next && this.lastResult)\n            observer.next(this.lastResult);\n        if (observer.error && this.lastError)\n            observer.error(this.lastError);\n        if (this.observers.length === 1)\n            this.setUpQuery();\n        return function () {\n            _this.observers = _this.observers.filter(function (obs) { return obs !== observer; });\n            if (_this.observers.length === 0) {\n                _this.tearDownQuery();\n            }\n        };\n    };\n    ObservableQuery.prototype.setUpQuery = function () {\n        var _this = this;\n        if (this.shouldSubscribe) {\n            this.queryManager.addObservableQuery(this.queryId, this);\n        }\n        if (!!this.options.pollInterval) {\n            if (this.options.fetchPolicy === 'cache-first' ||\n                this.options.fetchPolicy === 'cache-only') {\n                throw new Error('Queries that specify the cache-first and cache-only fetchPolicies cannot also be polling queries.');\n            }\n            this.isCurrentlyPolling = true;\n            this.scheduler.startPollingQuery(this.options, this.queryId);\n        }\n        var observer = {\n            next: function (result) {\n                _this.lastResult = result;\n                _this.lastResultSnapshot = cloneDeep(result);\n                _this.observers.forEach(function (obs) { return obs.next && obs.next(result); });\n            },\n            error: function (error) {\n                _this.lastError = error;\n                _this.observers.forEach(function (obs) { return obs.error && obs.error(error); });\n            },\n        };\n        this.queryManager.startQuery(this.queryId, this.options, this.queryManager.queryListenerForObserver(this.queryId, this.options, observer));\n    };\n    ObservableQuery.prototype.tearDownQuery = function () {\n        this.isTornDown = true;\n        if (this.isCurrentlyPolling) {\n            this.scheduler.stopPollingQuery(this.queryId);\n            this.isCurrentlyPolling = false;\n        }\n        this.subscriptionHandles.forEach(function (sub) { return sub.unsubscribe(); });\n        this.subscriptionHandles = [];\n        this.queryManager.removeObservableQuery(this.queryId);\n        this.queryManager.stopQuery(this.queryId);\n        this.observers = [];\n    };\n    return ObservableQuery;\n}(Observable));\nexport { ObservableQuery };\n//# sourceMappingURL=ObservableQuery.js.map"]},"metadata":{},"sourceType":"module"}